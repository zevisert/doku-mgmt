apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- helm/cainjector-deployment.yaml
- helm/cainjector-rbac.yaml
- helm/cainjector-serviceaccount.yaml
- helm/crds.yaml
- helm/deployment.yaml
- helm/rbac.yaml
- helm/serviceaccount.yaml
- helm/service.yaml
- helm/webhook-deployment.yaml
- helm/webhook-mutating-webhook.yaml
- helm/webhook-rbac.yaml
- helm/webhook-serviceaccount.yaml
- helm/webhook-service.yaml
- helm/webhook-validating-webhook.yaml
configurations:
- configurations.yaml
patches:
- patch: |-
    - op: replace
      path: "/metadata/annotations/cert-manager.io~1inject-ca-from-secret"
      value: $(WEBHOOK_DEPLOYMENT_NAMESPACE)/$(WEBHOOK_DEPLOYMENT_NAME)-ca
  target:
    annotationSelector: cert-manager.io/inject-ca-from-secret
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/args/3
      value: --dynamic-serving-ca-secret-name=$(WEBHOOK_DEPLOYMENT_NAME)-ca
    - op: replace
      path: /spec/template/spec/containers/0/args/4
      value: --dynamic-serving-dns-names=$(WEBHOOK_DEPLOYMENT_NAME),$(WEBHOOK_DEPLOYMENT_NAME).$(WEBHOOK_DEPLOYMENT_NAMESPACE),$(WEBHOOK_DEPLOYMENT_NAME).$(WEBHOOK_DEPLOYMENT_NAMESPACE).svc
  target:
    name: cert-manager-webhook
    kind: Deployment
- patch: |-
    - op: replace
      path: /webhooks/0/namespaceSelector/matchExpressions/1/values/0
      value: $(WEBHOOK_DEPLOYMENT_NAMESPACE)
  target:
    name: cert-manager-webhook
    kind: ValidatingWebhookConfiguration
vars:
- name: WEBHOOK_DEPLOYMENT_NAME
  fieldref:
    fieldPath: metadata.name
  objref:
    name: cert-manager-webhook
    apiVersion: apps/v1
    kind: Deployment
- name: WEBHOOK_DEPLOYMENT_NAMESPACE
  fieldref:
    fieldPath: metadata.namespace
  objref:
    name: cert-manager-webhook
    apiVersion: apps/v1
    kind: Deployment
